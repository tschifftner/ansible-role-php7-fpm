---

- name: Configure php7-fpm modules
  template:
    src: "{{ item }}"
    dest: "/etc/php/{{ php7_fpm_version }}/mods-available/{{ item | basename }}"
    force: yes
    owner: root
    group: root
    mode: 0644
  with_items: '{{php7_fpm_modules_config}}'
  notify: restart php{{ php7_fpm_version }}-fpm

- name: enable php7 modules
  command: phpenmod {{ item }}
  args:
    creates: "/etc/php/{{ php7_fpm_version }}/cli/conf.d/20-{{ item }}.ini"
  with_items: '{{php7_fpm_modules}}'
  changed_when: false # required for idempotence



#
# REMOVE DUPLICATE SYMLINKS
#
- name: Check if multiple opcache.ini exist
  stat:
    path: /etc/php/7.0/fpm/conf.d/20-opcache.ini
  register: opcache_file_exists

- name: remove old opcache.ini files
  file:
    path: '{{ item }}'
    state: absent
  when: opcache_file_exists is defined and opcache_file_exists.stat.exists
  with_items:
    - '/etc/php/7.0/fpm/conf.d/10-opcache.ini'
    - '/etc/php/7.0/cli/conf.d/10-opcache.ini'

#- name: Configure OpCache
#  template: src="mods-available/opcache.ini" dest="/etc/php/{{ php7_fpm_version }}/mods-available/opcache.ini" force=yes owner=root group=root mode=0644
#  when: php_opcache_enabled_in_ini
#  notify: restart php{{ php7_fpm_version }}-fpm
